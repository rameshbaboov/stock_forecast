{# app/templates/reports/stock_history.html #}
{% extends "base.html" %}

{% block title %}
Stock History{% if universe %} - {{ universe.symbol }} ({{ universe.exchange_code }}){% endif %}
{% endblock %}

{% block content %}
<h2>Stock History</h2>

{% if not universe %}
    <p>Universe item not found.</p>
{% else %}
    <div class="mb-3">
        <h3>{{ universe.symbol }} ({{ universe.exchange_code }})</h3>
        <table class="table table-sm">
            <tbody>
            <tr>
                <th scope="row">Exchange</th>
                <td>{{ universe.exchange_name }} ({{ universe.exchange_code }})</td>
            </tr>
            <tr>
                <th scope="row">yfinance ticker</th>
                <td>{{ universe.yfinance_ticker or "-" }}</td>
            </tr>
            <tr>
                <th scope="row">BSE code</th>
                <td>{{ universe.bse_code or "-" }}</td>
            </tr>
            <tr>
                <th scope="row">BSE ticker</th>
                <td>{{ universe.bse_ticker or "-" }}</td>
            </tr>
            <tr>
                <th scope="row">ISIN</th>
                <td>{{ universe.isin or "-" }}</td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="row">
        <div class="col-md-7">
            <h4>Recent Price History</h4>
            {% if prices and prices|length > 0 %}
                <table class="table table-striped table-sm">
                    <thead>
                    <tr>
                        <th>Date</th>
                        <th>Open</th>
                        <th>High</th>
                        <th>Low</th>
                        <th>Close</th>
                        <th>Volume</th>
                        <th>Source</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for p in prices %}
                    <tr>
                        <td>{{ p.trade_date }}</td>
                        <td>{{ "%.2f"|format(p.open) }}</td>
                        <td>{{ "%.2f"|format(p.high) }}</td>
                        <td>{{ "%.2f"|format(p.low) }}</td>
                        <td>{{ "%.2f"|format(p.close) }}</td>
                        <td>{{ p.volume }}</td>
                        <td>{{ p.source }}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No price history available.</p>
            {% endif %}
        </div>

        <div class="col-md-5">
            <h4>Recent Forecasts</h4>
            {% if forecasts and forecasts|length > 0 %}
                <table class="table table-striped table-sm">
                    <thead>
                    <tr>
                        <th>As of</th>
                        <th>Forecast date</th>
                        <th>Last close</th>
                        <th>Forecast return</th>
                        <th>Forecast price</th>
                        <th>Trend</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for f in forecasts %}
                    <tr>
                        <td>{{ f.as_of_date }}</td>
                        <td>{{ f.next_date }}</td>
                        <td>{{ "%.2f"|format(f.last_close) }}</td>
                        <td>{{ "%.4f"|format(f.forecast_return) }}</td>
                        <td>{{ "%.2f"|format(f.forecast_price) }}</td>
                        <td>{{ f.trend_flag }}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No forecast records available.</p>
            {% endif %}
        </div>
    </div>
{% endif %}

<p class="mt-3">
    <a href="/forecast/latest">&laquo; Back to latest forecasts</a> |
    <a href="/reports/summary">Summary report</a>
</p>
{% endblock %}
